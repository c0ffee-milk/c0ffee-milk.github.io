<!DOCTYPE html>
<html lang="en">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>pytorch ç®€æ˜“å…¥é—¨ - Hexo</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="pytorch ç®€æ˜“å…¥é—¨ - Hexo" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://example.com/2025/06/29/pytorch/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2025-06-29T13:08:08.000Z" />
  
  <meta property="og:article:author" content="Latteo" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  
  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/categories.css">

  
<link rel="stylesheet" href="/css/tags.css">

  
<link rel="stylesheet" href="/css/archive.css">

  
<link rel="stylesheet" href="/css/post.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/giscus.css">


    

    

  
<meta name="generator" content="Hexo 7.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/projects">Projects</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/c0ffee-milk" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        

        
        <div class="date" id="date">
            <span>June</span>
            <span>29,</span>
            <span>2025</span>
        </div>
        

        <h1 class="title">pytorch ç®€æ˜“å…¥é—¨</h1>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h2 id="1-PyTorch-çš„åŸºæœ¬æ¦‚å¿µ"><a href="#1-PyTorch-çš„åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="1. PyTorch çš„åŸºæœ¬æ¦‚å¿µ"></a><strong>1. PyTorch çš„åŸºæœ¬æ¦‚å¿µ</strong></h2><h3 id="1-1-Tensor"><a href="#1-1-Tensor" class="headerlink" title="1.1 Tensor"></a>1.1 Tensor</h3><p>Tensorç±»ä¼¼ä¸NumPyçš„ndarrayï¼Œä½†æ˜¯å¯ä»¥ç”¨GPUåŠ é€Ÿã€‚</p>
<ol>
<li><p>æ„é€ æœªåˆå§‹åŒ–çŸ©é˜µ <code>empty</code></p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">x = torch.empty(5, 3)</span><br><span class="line">print(x)</span><br><span class="line"></span><br><span class="line">tensor([[0., 0., 0.],</span><br><span class="line">        [0., 0., 0.],</span><br><span class="line">        [0., 0., 0.],</span><br><span class="line">        [0., 0., 0.],</span><br><span class="line">        [0., 0., 0.]])</span><br></pre></td></tr></table></figure>
</li>
<li><p>éšæœºåˆå§‹åŒ–ä¸€ä¸ªçŸ©é˜µ <code>rand</code></p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">x = torch.rand(5, 3)</span><br><span class="line">print(x)</span><br><span class="line"></span><br><span class="line">tensor([[0.6819, 0.1574, 0.6951],</span><br><span class="line">        [0.9938, 0.7842, 0.3295],</span><br><span class="line">        [0.6799, 0.4662, 0.9871],</span><br><span class="line">        [0.1258, 0.4621, 0.7077],</span><br><span class="line">        [0.3343, 0.1081, 0.6953]])</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ„é€ ä¸€ä¸ªé›¶åˆå§‹åŒ–çŸ©é˜µ <code>zeros</code></p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">x = torch.zeros(5, 3)</span><br><span class="line">print(x)</span><br><span class="line"></span><br><span class="line">tensor([[0., 0., 0.],</span><br><span class="line">        [0., 0., 0.],</span><br><span class="line">        [0., 0., 0.],</span><br><span class="line">        [0., 0., 0.],</span><br><span class="line">        [0., 0., 0.]])</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ„é€ ä¸€ä¸ªæŒ‡å®šæ•°æ®ç±»å‹çš„çŸ©é˜µ <code>dtype</code></p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">x = torch.rand(5, 3, dtype=torch.float32)</span><br><span class="line">print(x)</span><br><span class="line"></span><br><span class="line">tensor([[0.9735, 0.6720, 0.1250],</span><br><span class="line">        [0.3461, 0.6952, 0.1919],</span><br><span class="line">        [0.7887, 0.4517, 0.9117],</span><br><span class="line">        [0.5153, 0.8150, 0.3046],</span><br><span class="line">        [0.5150, 0.4235, 0.8831]])</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä½¿ç”¨æ•°ç»„æ„é€ Tensor</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x = torch.tensor([5.5, 3])</span><br><span class="line">print(x)</span><br><span class="line"></span><br><span class="line">tensor([5.5000, 3.0000])</span><br></pre></td></tr></table></figure>
</li>
<li><p>æŸ¥çœ‹ä¸€ä¸ªTensorçš„shape <code>size</code></p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">x = torch.zeros(5, 3)</span><br><span class="line">print(x)</span><br><span class="line">print(x.size())</span><br><span class="line"></span><br><span class="line">tensor([[0., 0., 0.],</span><br><span class="line">        [0., 0., 0.],</span><br><span class="line">        [0., 0., 0.],</span><br><span class="line">        [0., 0., 0.],</span><br><span class="line">        [0., 0., 0.]])</span><br><span class="line">torch.Size([5, 3])</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="1-2-Operation"><a href="#1-2-Operation" class="headerlink" title="1.2 Operation"></a>1.2 Operation</h3><p>Operationä¸€èˆ¬å¯ä»¥ä½¿ç”¨å‡½æ•°çš„æ–¹å¼ä½¿ç”¨ï¼Œä»¥åŠ æ³•ä¸ºä¾‹</p>
<ol>
<li><p>ç”¨è¿ç®—ç¬¦å®ç°åŠ æ³• <code>+</code></p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">x = torch.rand(5, 3)</span><br><span class="line">y = torch.rand(5, 3)</span><br><span class="line">print(x)</span><br><span class="line">print(y)</span><br><span class="line">print(x + y)</span><br><span class="line"></span><br><span class="line">tensor([[0.8217, 0.7760, 0.0340],</span><br><span class="line">        [0.0413, 0.5867, 0.6914],</span><br><span class="line">        [0.4074, 0.2192, 0.8599],</span><br><span class="line">        [0.1837, 0.4944, 0.1833],</span><br><span class="line">        [0.9589, 0.1776, 0.0896]])</span><br><span class="line">tensor([[0.5083, 0.3603, 0.0964],</span><br><span class="line">        [0.5016, 0.6730, 0.5046],</span><br><span class="line">        [0.7970, 0.7357, 0.1990],</span><br><span class="line">        [0.2162, 0.4779, 0.5341],</span><br><span class="line">        [0.8595, 0.5517, 0.4641]])</span><br><span class="line">tensor([[1.3300, 1.1363, 0.1304],</span><br><span class="line">        [0.5429, 1.2597, 1.1960],</span><br><span class="line">        [1.2044, 0.9549, 1.0589],</span><br><span class="line">        [0.3999, 0.9722, 0.7175],</span><br><span class="line">        [1.8184, 0.7293, 0.5537]])</span><br></pre></td></tr></table></figure>
</li>
<li><p>ç”¨å‡½æ•°å®ç°åŠ æ³• <code>torch.add()</code></p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">x = torch.rand(5, 3)</span><br><span class="line">y = torch.rand(5, 3)</span><br><span class="line">print(x)</span><br><span class="line">print(y)</span><br><span class="line">print(torch.add(x, y))</span><br><span class="line"></span><br><span class="line">tensor([[0.4643, 0.0701, 0.3483],</span><br><span class="line">        [0.1846, 0.7678, 0.8397],</span><br><span class="line">        [0.9759, 0.9102, 0.5844],</span><br><span class="line">        [0.2472, 0.2512, 0.6340],</span><br><span class="line">        [0.2352, 0.7352, 0.9725]])</span><br><span class="line">tensor([[0.0229, 0.0309, 0.7605],</span><br><span class="line">        [0.5113, 0.8178, 0.3730],</span><br><span class="line">        [0.8731, 0.6131, 0.5512],</span><br><span class="line">        [0.7176, 0.8111, 0.4682],</span><br><span class="line">        [0.5177, 0.2994, 0.3149]])</span><br><span class="line">tensor([[0.4872, 0.1010, 1.1088],</span><br><span class="line">        [0.6959, 1.5856, 1.2127],</span><br><span class="line">        [1.8490, 1.5233, 1.1356],</span><br><span class="line">        [0.9649, 1.0623, 1.1022],</span><br><span class="line">        [0.7528, 1.0346, 1.2874]])</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¸ºåŠ æ³•æä¾›è¿”å›å€¼ <code>out=</code></p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">x = torch.rand(5, 3)</span><br><span class="line">y = torch.rand(5, 3)</span><br><span class="line">result = torch.empty(5, 3)</span><br><span class="line">torch.add(x, y, out=result)</span><br><span class="line">print(result)</span><br><span class="line"></span><br><span class="line">tensor([[1.3815, 1.2649, 1.3772],</span><br><span class="line">        [0.8191, 1.0258, 0.7270],</span><br><span class="line">        [1.5077, 1.2752, 0.8296],</span><br><span class="line">        [0.8453, 1.0702, 1.3118],</span><br><span class="line">        [1.0655, 1.7370, 0.9018]])</span><br></pre></td></tr></table></figure>
</li>
<li><p>åŸåœ°ä¿®æ”¹Tensor <code>add_(ä»¥ä¸‹åˆ’çº¿ç»“å°¾)</code></p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">x = torch.rand(5, 3)</span><br><span class="line">y = torch.rand(5, 3)</span><br><span class="line">print(x)</span><br><span class="line">print(y)</span><br><span class="line">print(y.add_(x))</span><br><span class="line"></span><br><span class="line">tensor([[0.1245, 0.0032, 0.2941],</span><br><span class="line">        [0.6233, 0.5174, 0.7957],</span><br><span class="line">        [0.6105, 0.4572, 0.8840],</span><br><span class="line">        [0.6559, 0.8040, 0.7680],</span><br><span class="line">        [0.0818, 0.1590, 0.2294]])</span><br><span class="line">tensor([[0.6524, 0.8919, 0.6358],</span><br><span class="line">        [0.8619, 0.3013, 0.1395],</span><br><span class="line">        [0.7151, 0.4323, 0.2184],</span><br><span class="line">        [0.5981, 0.9320, 0.9239],</span><br><span class="line">        [0.0647, 0.4407, 0.3301]])</span><br><span class="line">tensor([[0.7769, 0.8951, 0.9299],</span><br><span class="line">        [1.4853, 0.8186, 0.9352],</span><br><span class="line">        [1.3256, 0.8895, 1.1024],</span><br><span class="line">        [1.2540, 1.7360, 1.6919],</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="1-3-Tensorçš„å˜æ¢"><a href="#1-3-Tensorçš„å˜æ¢" class="headerlink" title="1.3 Tensorçš„å˜æ¢"></a>1.3 Tensorçš„å˜æ¢</h3><ol>
<li><p>resizeå’Œreshapeä¸€ä¸ªTensor <code>torch.view</code></p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">x = torch.rand(4, 4)</span><br><span class="line">y = x.view(-1, 2) # -1è¡¨ç¤ºè®©Pytorchè‡ªå·±æ¨æ–­è¯¥ç»´çš„å¤§å°</span><br><span class="line">z = x.view(16)</span><br><span class="line">print(x)</span><br><span class="line">print(y)</span><br><span class="line">print(z)</span><br><span class="line"></span><br><span class="line">tensor([[0.7446, 0.6093, 0.6807, 0.3331],</span><br><span class="line">        [0.5358, 0.1826, 0.0263, 0.8574],</span><br><span class="line">        [0.6927, 0.6911, 0.7574, 0.4551],</span><br><span class="line">        [0.0486, 0.9530, 0.8304, 0.0535]])</span><br><span class="line">tensor([[0.7446, 0.6093],</span><br><span class="line">        [0.6807, 0.3331],</span><br><span class="line">        [0.5358, 0.1826],</span><br><span class="line">        [0.0263, 0.8574],</span><br><span class="line">        [0.6927, 0.6911],</span><br><span class="line">        [0.7574, 0.4551],</span><br><span class="line">        [0.0486, 0.9530],</span><br><span class="line">        [0.8304, 0.0535]])</span><br><span class="line">tensor([0.7446, 0.6093, 0.6807, 0.3331, 0.5358, 0.1826, 0.0263, 0.8574, 0.6927,</span><br><span class="line">        0.6911, 0.7574, 0.4551, 0.0486, 0.9530, 0.8304, 0.0535])</span><br></pre></td></tr></table></figure>
</li>
<li><p>å°†å•ä¸ªå…ƒç´ çš„Tensorè½¬åŒ–ä¸ºPython number <code>torch.item</code></p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">x = torch.randn(1)</span><br><span class="line">print(x)</span><br><span class="line">#è¾“å‡ºçš„æ˜¯ä¸€ä¸ªTensor</span><br><span class="line">tensor([-0.6966])</span><br><span class="line"></span><br><span class="line">print(x.item())</span><br><span class="line">#è¾“å‡ºçš„æ˜¯ä¸€ä¸ªæ•°</span><br><span class="line">-0.6966081857681274</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="1-4-Tensor-ä¸-Numpy-çš„ç›¸äº’è½¬æ¢"><a href="#1-4-Tensor-ä¸-Numpy-çš„ç›¸äº’è½¬æ¢" class="headerlink" title="1.4 Tensor ä¸ Numpy çš„ç›¸äº’è½¬æ¢"></a>1.4 Tensor ä¸ Numpy çš„ç›¸äº’è½¬æ¢</h3><p>Tensor ä¸ Numpy å…±äº«å†…å­˜åœ°å€ï¼Œå½“å…¶ä¸­ä¸€æ–¹è¢«ä¿®æ”¹æ—¶ä¹Ÿä¼šå½±å“å¦ä¸€æ–¹ã€‚</p>
<p>æŠŠNumPyæ•°ç»„è½¬æˆTorch Tensor <code>torch.from_numpy()</code>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import numpy as np</span><br><span class="line">a = np.ones(5)</span><br><span class="line">b = torch.from_numpy(a)</span><br><span class="line">np.add(a, 1, out=a)</span><br><span class="line">print(a)</span><br><span class="line"># [2. 2. 2. 2. 2.]</span><br><span class="line">print(b)</span><br><span class="line"># tensor([ 2.,  2.,  2.,  2.,  2.], dtype=torch.float64)</span><br></pre></td></tr></table></figure>

<h3 id="1-5-CUDA-Tensor"><a href="#1-5-CUDA-Tensor" class="headerlink" title="1.5 CUDA Tensor"></a>1.5 CUDA Tensor</h3><p>Tensorå¯ä»¥ä½¿ç”¨to()æ–¹æ³•æ¥ç§»åˆ°ä»»æ„è®¾å¤‡ä¸Š</p>
<p>å¦‚æœè®¾å¤‡æœ‰cudaï¼Œä½¿ç”¨ <code>torch.device</code>  å°†tensorsæ”¾åœ¨GPUä¸Š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">x = torch.rand(4, 4)</span><br><span class="line">if torch.cuda.is_available():</span><br><span class="line">        device = torch.device(&quot;cuda&quot;)</span><br><span class="line">        y = torch.ones_like(x, device=device)</span><br><span class="line">        x = x.to(device)</span><br><span class="line">        z = x + y</span><br><span class="line">        print(z)</span><br><span class="line">        print(z.to(&quot;cpu&quot;, torch.double))</span><br></pre></td></tr></table></figure>

<h3 id="1-6-Autograd-è‡ªåŠ¨æ±‚å¯¼"><a href="#1-6-Autograd-è‡ªåŠ¨æ±‚å¯¼" class="headerlink" title="1.6 Autograd è‡ªåŠ¨æ±‚å¯¼"></a>1.6 Autograd è‡ªåŠ¨æ±‚å¯¼</h3><p>Autograd åŒ…æ˜¯ Pytorch çš„æ ¸å¿ƒï¼ŒAutogradä¸ºæ‰€æœ‰ç”¨äºTensorçš„operationæä¾›è‡ªåŠ¨æ±‚å¯¼çš„åŠŸèƒ½ã€‚</p>
<ol>
<li>åå‘ä¼ æ’­<br>torch.Tensor æ˜¯ AutogradåŒ…çš„æ ¸å¿ƒç±»ï¼Œè‹¥å…¶å±æ€§requires_grad ä¸ºTrueï¼ŒPyTorchå°±ä¼šè¿½è¸ªæ‰€æœ‰ä¸ä¹‹ç›¸å…³çš„operationã€‚å½“å®Œæˆ(æ­£å‘)è®¡ç®—ä¹‹åï¼Œ æˆ‘ä»¬å¯ä»¥è°ƒç”¨backward()ï¼ŒPyTorchä¼šè‡ªåŠ¨çš„æŠŠæ‰€æœ‰çš„æ¢¯åº¦éƒ½è®¡ç®—å¥½ã€‚ä¸è¿™ä¸ªtensorç›¸å…³çš„æ¢¯åº¦éƒ½ä¼šç´¯åŠ åˆ°å®ƒçš„gradå±æ€§é‡Œã€‚</li>
<li>ç¦ç”¨åå‘ä¼ æ’­<br>å¦‚æœä¸æƒ³è®¡ç®—è¿™ä¸ªtensorçš„æ¢¯åº¦ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨detach()ï¼Œè¿™æ ·å®ƒå°±ä¸ä¼šå‚ä¸æ¢¯åº¦çš„è®¡ç®—äº†ã€‚ä¸ºäº†é˜»æ­¢PyTorchè®°å½•ç”¨äºæ¢¯åº¦è®¡ç®—ç›¸å…³çš„ä¿¡æ¯(ä»è€ŒèŠ‚çº¦å†…å­˜)ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ with torch.no_grad()ã€‚è¿™åœ¨æ¨¡å‹çš„æ¨ç†æ—¶éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºæ¨ç†çš„æ—¶å€™æˆ‘ä»¬ä¸éœ€è¦è®¡ç®—æ¢¯åº¦ï¼Œå¦åˆ™æˆ‘ä»¬å°±å¾—ä¸€ä¸ªä¸ªçš„ä¿®æ”¹Tensorçš„requires_gradå±æ€§ï¼Œè¿™ä¼šéå¸¸éº»çƒ¦ã€‚</li>
<li>è®¡ç®—æ¢¯åº¦<br>å¦‚æœå¸Œæœ›æƒ³è®¡ç®—æ¢¯åº¦ï¼Œå¯ä»¥å¯¹ä¸€ä¸ªTensorè°ƒç”¨å®ƒçš„backward()æ–¹æ³•ã€‚å¦‚æœè¿™ä¸ªTensoræ˜¯ä¸€ä¸ªscalar(åªæœ‰ä¸€ä¸ªæ•°)ï¼Œé‚£ä¹ˆè°ƒç”¨æ—¶ä¸éœ€è¦ä¼ ä»»ä½•å‚æ•°ã€‚å¦‚æœTensorå¤šäºä¸€ä¸ªæ•°ï¼Œé‚£ä¹ˆéœ€è¦ä¼ å…¥å’Œå®ƒçš„shapeä¸€æ ·çš„å‚æ•°ï¼Œè¡¨ç¤ºåå‘ä¼ æ’­è¿‡æ¥çš„æ¢¯åº¦ã€‚</li>
</ol>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># åˆ›å»ºtensoræ—¶è®¾ç½®å±æ€§requires_grad=True</span><br><span class="line">x = torch.ones(2, 2, requires_grad=True)</span><br><span class="line">print(x)</span><br><span class="line"></span><br><span class="line"># é€šè¿‡Operationäº§ç”Ÿæ–°çš„tensor</span><br><span class="line">y = x + 2</span><br><span class="line">print(y)</span><br><span class="line"></span><br><span class="line"># é€šè¿‡Operationäº§ç”Ÿçš„tensorï¼Œå…¶grad_fnä¸ä¸ºNone</span><br><span class="line">print(y.grad_fn)</span><br><span class="line"></span><br><span class="line">z = y * y * 3</span><br><span class="line">out = z.mean()</span><br><span class="line"></span><br><span class="line">print(z)</span><br><span class="line">print(out)</span><br><span class="line"></span><br><span class="line">tensor([[1., 1.],</span><br><span class="line">        [1., 1.]], requires_grad=True)</span><br><span class="line">tensor([[3., 3.],</span><br><span class="line">        [3., 3.]], grad_fn=&lt;AddBackward0&gt;)</span><br><span class="line">&lt;AddBackward0 object at 0x1007be670&gt;</span><br><span class="line">tensor([[27., 27.],</span><br><span class="line">        [27., 27.]], grad_fn=&lt;MulBackward0&gt;)</span><br><span class="line">tensor(27., grad_fn=&lt;MeanBackward0&gt;)</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ <code>requires_grad_()</code>  æ”¹å˜ä¸€ä¸ªtensorçš„requires_grad</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">a = torch.randn(2, 2)</span><br><span class="line">a = ((a * 3) / (a - 1))</span><br><span class="line">print(a.requires_grad)</span><br><span class="line">a.requires_grad_(True)</span><br><span class="line">print(a.requires_grad)</span><br><span class="line">b = (a * a).sum()</span><br><span class="line">print(b.grad_fn)</span><br><span class="line"></span><br><span class="line">False</span><br><span class="line">True</span><br><span class="line">&lt;SumBackward0 object at 0x102b36670&gt;</span><br></pre></td></tr></table></figure>

<h3 id="1-7-æ¢¯åº¦"><a href="#1-7-æ¢¯åº¦" class="headerlink" title="1.7 æ¢¯åº¦"></a>1.7 æ¢¯åº¦</h3><p>ä½¿ç”¨ <code>backword()</code> åå‘è®¡ç®—æ¢¯åº¦</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">out.backward()</span><br><span class="line">print(x.grad)</span><br><span class="line"></span><br><span class="line">tensor([[4.5000, 4.5000],</span><br><span class="line">        [4.5000, 4.5000]])</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ <code>with torch.no_grad()</code> åœæ­¢è®¡ç®—æ¢¯åº¦</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">x = torch.ones(2, 2, requires_grad=True)</span><br><span class="line">print(x.requires_grad)</span><br><span class="line">print((x ** 2).requires_grad)</span><br><span class="line"></span><br><span class="line">with torch.no_grad():</span><br><span class="line">  print((x ** 2).requires_grad)</span><br><span class="line"></span><br><span class="line">True</span><br><span class="line">True</span><br><span class="line">False</span><br></pre></td></tr></table></figure>

<h2 id="2-PyTorch-ç¥ç»ç½‘ç»œ"><a href="#2-PyTorch-ç¥ç»ç½‘ç»œ" class="headerlink" title="2. PyTorch ç¥ç»ç½‘ç»œ"></a><strong>2. PyTorch ç¥ç»ç½‘ç»œ</strong></h2><p>ç¥ç»ç½‘ç»œå¯ä»¥é€šè¿‡torch.nnåŒ…æ¥åˆ›å»ºã€‚æˆ‘ä»¬ä¹‹å‰ç®€å•çš„äº†è§£äº†autogradï¼Œè€Œnnä¼šä½¿ç”¨autogradæ¥å®šä¹‰æ¨¡å‹ä»¥åŠæ±‚æ¢¯åº¦ã€‚ä¸€ä¸ªnn.Moduleå¯¹è±¡åŒ…æ‹¬äº†è®¸å¤šç½‘ç»œå±‚(layer)ï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªforward(input)æ–¹æ³•æ¥è¿”å›outputã€‚</p>
<p>ä¸‹å›¾æ˜¯ä¸€ä¸ªè¯†åˆ«mnistå›¾ç‰‡çš„å·ç§¯ç½‘ç»œç»“æ„ï¼š</p>
<p><img src="https://raw.githubusercontent.com/c0ffee-milk/photo/master/202506302313658.png" alt="mnist"></p>
<p>è®­ç»ƒä¸€ä¸ªç¥ç»ç½‘ç»œé€šå¸¸éœ€è¦å¦‚ä¸‹æ­¥éª¤ï¼š</p>
<ol>
<li><p>å®šä¹‰ä¸€ä¸ªç¥ç»ç½‘ç»œï¼Œå®ƒé€šå¸¸æœ‰ä¸€äº›å¯ä»¥è®­ç»ƒçš„å‚æ•°</p>
</li>
<li><p>è¿­ä»£ä¸€ä¸ªæ•°æ®é›†(dataset)</p>
</li>
<li><p>å¤„ç†ç½‘ç»œçš„è¾“å…¥</p>
</li>
<li><p>è®¡ç®—loss(ä¼šè°ƒç”¨Moduleå¯¹è±¡çš„forwardæ–¹æ³•)</p>
</li>
<li><p>è®¡ç®—losså¯¹å‚æ•°çš„æ¢¯åº¦</p>
</li>
<li><p>æ›´æ–°å‚æ•°ï¼Œé€šå¸¸ä½¿ç”¨å¦‚ä¸‹çš„æ¢¯åº¦ä¸‹é™æ–¹æ³•æ¥æ›´æ–°ï¼š</p>
<p> weight &#x3D; weight - learning_rate * gradient</p>
</li>
</ol>
<h3 id="2-1-å®šä¹‰ç½‘ç»œ"><a href="#2-1-å®šä¹‰ç½‘ç»œ" class="headerlink" title="2.1 å®šä¹‰ç½‘ç»œ"></a>2.1 å®šä¹‰ç½‘ç»œ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">import torch</span><br><span class="line">import torch.nn as nn</span><br><span class="line">import torch.nn.functional as F</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Net(nn.Module):</span><br><span class="line">      def __init__(self):</span><br><span class="line">              super(Net, self).__init__()</span><br><span class="line">              # ç¬¬ä¸€å±‚å·ç§¯å±‚ï¼Œè¾“å…¥1ä¸ªé€šé“ï¼ˆç°åº¦å›¾ï¼‰ï¼Œè¾“å‡º6ä¸ªé€šé“ï¼ˆfeature mapï¼‰ï¼Œä½¿ç”¨5*5çš„å·ç§¯æ ¸</span><br><span class="line">              self.conv1 = nn.Conv2d(1, 6, 5)</span><br><span class="line">              # ç¬¬äºŒå±‚å·ç§¯å±‚ï¼Œè¾“å…¥6ä¸ªé€šé“ï¼Œè¾“å‡º16ä¸ªé€šé“ï¼Œä½¿ç”¨5*5çš„å·ç§¯æ ¸</span><br><span class="line">              self.conv2 = nn.Conv2d(6, 16, 5)</span><br><span class="line">              # å…¨è¿æ¥å±‚</span><br><span class="line">              self.fc1 = nn.Linear(16*5*5, 120)</span><br><span class="line">              self.fc2 = nn.Linear(120, 84)</span><br><span class="line">              self.fc3 = nn.Linear(84, 10)</span><br><span class="line"></span><br><span class="line">      # å‰å‘ä¼ æ’­</span><br><span class="line">      def forward(self, x):</span><br><span class="line">              # ç¬¬ä¸€å±‚å·ç§¯+æ± åŒ–å±‚ 32x32 -&gt; 28x28 -&gt; 14x14</span><br><span class="line">              x = F.max_pool2d(F.relu(self.conv1(x)), (2, 2))</span><br><span class="line">              # ç¬¬äºŒå±‚å·ç§¯+æ± åŒ–å±‚ 14x14 -&gt; 10x10 -&gt; 5x5</span><br><span class="line">              x = F.max_pool2d(F.relu(self.conv2(x)), 2) # 2ä¸ï¼ˆ2ï¼Œ 2ï¼‰æ•ˆæœç›¸åŒ</span><br><span class="line">              x = x.view(-1, self.num_flat_features(x)) # å°†å¤šç»´å¼ é‡å¹³é“ºä¸ºäºŒç»´å¼ é‡</span><br><span class="line">              x = F.relu(self.fc1(x))</span><br><span class="line">              x = F.relu(self.fc2(x))</span><br><span class="line">              x = self.fc3(x)</span><br><span class="line">              return x</span><br><span class="line"></span><br><span class="line">      def num_flat_features(self, x):</span><br><span class="line">              size = x.size()[1:]  # é™¤äº†batchç»´åº¦ä¹‹å¤–çš„å…¶å®ƒç»´åº¦ã€‚</span><br><span class="line">              num_features = 1</span><br><span class="line">              for s in size:</span><br><span class="line">              num_features *= s</span><br><span class="line">              return num_features</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">net = Net()</span><br><span class="line">print(net)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Net(</span><br><span class="line">  (conv1): Conv2d(1, 6, kernel_size=(5, 5), stride=(1, 1))</span><br><span class="line">  (conv2): Conv2d(6, 16, kernel_size=(5, 5), stride=(1, 1))</span><br><span class="line">  (fc1): Linear(in_features=400, out_features=120, bias=True)</span><br><span class="line">  (fc2): Linear(in_features=120, out_features=84, bias=True)</span><br><span class="line">  (fc3): Linear(in_features=84, out_features=10, bias=True)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬åªéœ€è¦å®šä¹‰forwardå‡½æ•°ï¼Œè€Œbackwardå‡½æ•°ä¼šè‡ªåŠ¨é€šè¿‡autogradåˆ›å»ºã€‚åœ¨forwardå‡½æ•°é‡Œå¯ä»¥ä½¿ç”¨ä»»ä½•å¤„ç†Tensorçš„å‡½æ•°ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‡½æ•°net.parameters()æ¥å¾—åˆ°æ¨¡å‹æ‰€æœ‰çš„å‚æ•°ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">params = list(net.parameters())</span><br><span class="line">print(len(params))</span><br><span class="line"># 10</span><br><span class="line">print(params[0].size())  # conv1çš„weight</span><br><span class="line"># torch.Size([6, 1, 5, 5])</span><br></pre></td></tr></table></figure>

<h3 id="2-2-æµ‹è¯•ç½‘ç»œ"><a href="#2-2-æµ‹è¯•ç½‘ç»œ" class="headerlink" title="2.2 æµ‹è¯•ç½‘ç»œ"></a>2.2 æµ‹è¯•ç½‘ç»œ</h3><p>è¿™ä¸ªç½‘ç»œ(LeNet)æœŸæœ›çš„è¾“å…¥å¤§å°æ˜¯32x32ã€‚å¦‚æœä½¿ç”¨MNISTæ•°æ®é›†(28x28)ï¼Œæˆ‘ä»¬éœ€è¦ç¼©æ”¾åˆ°32x32ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">input = torch.randn(1, 1, 32, 32)</span><br><span class="line">out = net(input)</span><br><span class="line">print(out)</span><br><span class="line"></span><br><span class="line">tensor([[-0.0279, -0.0748,  0.0013,  0.0537,  0.0150, -0.1020, 0.0109, -0.0757, -0.0951,  0.0703]], grad_fn=&lt;AddmmBackward0&gt;)</span><br></pre></td></tr></table></figure>

<p>é»˜è®¤çš„æ¢¯åº¦ä¼šç´¯åŠ ï¼Œå› æ­¤æˆ‘ä»¬é€šå¸¸åœ¨backwardä¹‹å‰æ¸…é™¤æ‰ä¹‹å‰çš„æ¢¯åº¦å€¼ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net.zero_grad()</span><br><span class="line">out.backward(torch.randn(1, 10))</span><br></pre></td></tr></table></figure>

<h3 id="2-3-æŸå¤±å‡½æ•°"><a href="#2-3-æŸå¤±å‡½æ•°" class="headerlink" title="2.3 æŸå¤±å‡½æ•°"></a>2.3 æŸå¤±å‡½æ•°</h3><p>æŸå¤±å‡½æ•°çš„å‚æ•°æ˜¯(output, target)å¯¹ï¼Œoutputæ˜¯æ¨¡å‹çš„é¢„æµ‹ï¼Œtargetæ˜¯å®é™…çš„å€¼ã€‚æŸå¤±å‡½æ•°ä¼šè®¡ç®—é¢„æµ‹å€¼å’ŒçœŸå®å€¼çš„å·®åˆ«ï¼ŒæŸå¤±è¶Šå°è¯´æ˜é¢„æµ‹çš„è¶Šå‡†ã€‚</p>
<p>æœ€ç®€å•çš„ä¸€ä¸ªæŸå¤±å‡½æ•°æ˜¯ï¼šnn.MSELossï¼Œå®ƒä¼šè®¡ç®—é¢„æµ‹å€¼å’ŒçœŸå®å€¼çš„å‡æ–¹è¯¯å·®ã€‚æ¯”å¦‚ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">output = net(input)</span><br><span class="line">target = torch.arange(1, 11)</span><br><span class="line">target = target.view(1, -1)</span><br><span class="line">criterion = nn.MSELoss()</span><br><span class="line"></span><br><span class="line">loss = criterion(output, target)</span><br><span class="line">print(loss)</span><br></pre></td></tr></table></figure>

<h3 id="2-4-è®¡ç®—æ¢¯åº¦"><a href="#2-4-è®¡ç®—æ¢¯åº¦" class="headerlink" title="2.4 è®¡ç®—æ¢¯åº¦"></a>2.4 è®¡ç®—æ¢¯åº¦</h3><p>åœ¨è°ƒç”¨loss.backward()ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ¸…é™¤æ‰tensoré‡Œä¹‹å‰çš„æ¢¯åº¦ï¼Œå¦åˆ™ä¼šç´¯åŠ è¿›å»ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">net.zero_grad()     # æ¸…æ‰tensoré‡Œç¼“å­˜çš„æ¢¯åº¦å€¼ã€‚</span><br><span class="line"></span><br><span class="line">print(&#x27;conv1.bias.grad before backward&#x27;)</span><br><span class="line">print(net.conv1.bias.grad)</span><br><span class="line"></span><br><span class="line">loss.backward()</span><br><span class="line"></span><br><span class="line">print(&#x27;conv1.bias.grad after backward&#x27;)</span><br><span class="line">print(net.conv1.bias.grad)</span><br></pre></td></tr></table></figure>

<h3 id="2-5-æ›´æ–°å‚æ•°"><a href="#2-5-æ›´æ–°å‚æ•°" class="headerlink" title="2.5 æ›´æ–°å‚æ•°"></a>2.5 æ›´æ–°å‚æ•°</h3><p>æ›´æ–°å‚æ•°æœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨éšæœºæ¢¯åº¦ä¸‹é™(SGD)ï¼š ğ‘¤ğ‘’ğ‘–ğ‘”â„ğ‘¡&#x3D;ğ‘¤ğ‘’ğ‘–ğ‘”â„ğ‘¡âˆ’ğ‘™ğ‘’ğ‘ğ‘Ÿğ‘›ğ‘–ğ‘›ğ‘”ğ‘Ÿğ‘ğ‘¡ğ‘’âˆ—ğ‘”ğ‘Ÿğ‘ğ‘‘ğ‘–ğ‘’ğ‘›ğ‘¡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">learning_rate = 0.01</span><br><span class="line">for f in net.parameters():</span><br><span class="line">  f.data.sub_(f.grad.data * learning_rate)</span><br></pre></td></tr></table></figure>

<p>é€šå¸¸æˆ‘ä»¬ä¼šä½¿ç”¨æ›´åŠ å¤æ‚çš„ä¼˜åŒ–æ–¹æ³•ï¼Œæ¯”å¦‚SGD, Nesterov-SGD, Adam, RMSPropç­‰ç­‰ã€‚ä¸ºäº†å®ç°è¿™äº›ç®—æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨torch.optimåŒ…ï¼Œå®ƒçš„ç”¨æ³•ä¹Ÿéå¸¸ç®€å•ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import torch.optim as optim</span><br><span class="line"></span><br><span class="line"># åˆ›å»ºoptimizeréœ€è¦ä¼ å…¥å‚æ•°å’Œlearning rate</span><br><span class="line">optimizer = optim.SGD(net.parameters(), lr=0.01)</span><br><span class="line"></span><br><span class="line"># æ¸…é™¤æ¢¯åº¦</span><br><span class="line">optimizer.zero_grad()</span><br><span class="line">output = net(input)</span><br><span class="line">loss = criterion(output, target)</span><br><span class="line">loss.backward()</span><br><span class="line">optimizer.step()    # optimizerä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬æ›´æ–°å‚æ•°</span><br></pre></td></tr></table></figure>

<h2 id="3-è®­ç»ƒä¸€ä¸ªåˆ†ç±»å™¨"><a href="#3-è®­ç»ƒä¸€ä¸ªåˆ†ç±»å™¨" class="headerlink" title="3. è®­ç»ƒä¸€ä¸ªåˆ†ç±»å™¨"></a><strong>3. è®­ç»ƒä¸€ä¸ªåˆ†ç±»å™¨</strong></h2><h3 id="3-1-æ•°æ®å¤„ç†"><a href="#3-1-æ•°æ®å¤„ç†" class="headerlink" title="3.1 æ•°æ®å¤„ç†"></a>3.1 æ•°æ®å¤„ç†</h3><p>ä¸€èˆ¬åœ°ï¼Œå½“æˆ‘ä»¬å¤„ç†å›¾ç‰‡ã€æ–‡æœ¬ã€éŸ³é¢‘æˆ–è€…è§†é¢‘æ•°æ®çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨pythonä»£ç æ¥æŠŠå®ƒè½¬æ¢æˆnumpyæ•°ç»„ã€‚ç„¶åå†æŠŠnumpyæ•°ç»„è½¬æ¢æˆtorch.xxxTensorã€‚</p>
<p>CIFAR10æ•°æ®é›†åŒ…æ‹¬åä¸ªç±»åˆ«ï¼šâ€airplaneâ€, â€œautomobileâ€, â€œbirdâ€, â€œcatâ€, â€œdeerâ€, â€œdogâ€, â€œfrogâ€, â€œhorseâ€, â€œshipâ€,â€truckâ€ã€‚å›¾åƒçš„å¯¹è±¡æ˜¯3x32x32ï¼Œä¹Ÿå°±æ˜¯3é€šé“(RGB)çš„32x32çš„å›¾ç‰‡ã€‚</p>
<p><img src="https://raw.githubusercontent.com/c0ffee-milk/photo/master/202506302313517.png" alt="cifar10"></p>
<h3 id="3-2-è®­ç»ƒæ­¥éª¤"><a href="#3-2-è®­ç»ƒæ­¥éª¤" class="headerlink" title="3.2 è®­ç»ƒæ­¥éª¤"></a>3.2 è®­ç»ƒæ­¥éª¤</h3><ol>
<li>ä½¿ç”¨torchvisionåŠ è½½å’Œé¢„å¤„ç†CIFAR10è®­ç»ƒå’Œæµ‹è¯•æ•°æ®é›†ã€‚</li>
<li>å®šä¹‰å·ç§¯ç½‘ç»œ</li>
<li>å®šä¹‰æŸå¤±å‡½æ•°</li>
<li>ç”¨è®­ç»ƒæ•°æ®è®­ç»ƒæ¨¡å‹</li>
<li>ç”¨æµ‹è¯•æ•°æ®æµ‹è¯•æ¨¡å‹</li>
</ol>
<h3 id="3-3-åŠ è½½æ•°æ®"><a href="#3-3-åŠ è½½æ•°æ®" class="headerlink" title="3.3 åŠ è½½æ•°æ®"></a>3.3 åŠ è½½æ•°æ®</h3><p>ä½¿ç”¨torchvisionåŠ è½½CIFAR10æ•°æ®é›†ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import torch</span><br><span class="line">import torchvision</span><br><span class="line">import torchvision.transforms as transforms</span><br></pre></td></tr></table></figure>

<p>torchvisionè¯»å–çš„datasetsæ˜¯PILImageå¯¹è±¡ï¼Œå®ƒçš„å–å€¼èŒƒå›´æ˜¯[0, 1]ï¼Œæˆ‘ä»¬æŠŠå®ƒè½¬æ¢åˆ°èŒƒå›´[-1, 1]ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"># å¯¼å…¥å¿…è¦çš„å›¾åƒå˜æ¢æ¨¡å—ï¼ˆtransformsï¼‰å’Œæ•°æ®é›†æ¨¡å—ï¼ˆå¦‚ CIFAR10ï¼‰</span><br><span class="line">import torchvision.transforms as transforms</span><br><span class="line">import torchvision</span><br><span class="line"></span><br><span class="line"># å®šä¹‰å›¾åƒé¢„å¤„ç†æ“ä½œï¼šå°†å›¾åƒè½¬æ¢ä¸ºå¼ é‡ï¼Œå¹¶è¿›è¡Œæ ‡å‡†åŒ–</span><br><span class="line">transform = transforms.Compose(</span><br><span class="line">    [</span><br><span class="line">        # å°† PIL å›¾åƒæˆ– numpy æ•°ç»„è½¬æ¢ä¸º Tensor å¼ é‡</span><br><span class="line">        transforms.ToTensor(),</span><br><span class="line"></span><br><span class="line">        # å¯¹å›¾åƒè¿›è¡Œæ ‡å‡†åŒ–å¤„ç†ï¼š</span><br><span class="line">        # æ¯ä¸ªé€šé“å‡å»å‡å€¼ï¼Œå†é™¤ä»¥æ ‡å‡†å·®</span><br><span class="line">        # è¿™é‡Œä½¿ç”¨çš„æ˜¯ CIFAR-10 æ•°æ®é›†çš„ç»éªŒå‚æ•°</span><br><span class="line">        transforms.Normalize((0.5, 0.5, 0.5), (0.5, 0.5, 0.5))  # è¾“å…¥èŒƒå›´ [0,1] â†’ è¾“å‡ºèŒƒå›´ [-1,1]</span><br><span class="line">    ]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># åˆ›å»ºè®­ç»ƒé›†å¯¹è±¡</span><br><span class="line">trainset = torchvision.datasets.CIFAR10(</span><br><span class="line">    root=&#x27;/path/to/data&#x27;,     # æ•°æ®å­˜å‚¨è·¯å¾„</span><br><span class="line">    train=True,               # è¡¨ç¤ºè¿™æ˜¯è®­ç»ƒé›†</span><br><span class="line">    download=True,            # å¦‚æœæœ¬åœ°æ²¡æœ‰æ•°æ®ï¼Œåˆ™è‡ªåŠ¨ä¸‹è½½</span><br><span class="line">    transform=transform       # åº”ç”¨ä¸Šé¢å®šä¹‰çš„å›¾åƒé¢„å¤„ç†æ“ä½œ</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># åˆ›å»ºè®­ç»ƒé›†çš„æ•°æ®åŠ è½½å™¨ DataLoader</span><br><span class="line">trainloader = torch.utils.data.DataLoader(</span><br><span class="line">    trainset,                  # ä½¿ç”¨çš„æ•°æ®é›†</span><br><span class="line">    batch_size=4,              # æ¯ä¸ªæ‰¹æ¬¡åŒ…å«4ä¸ªæ ·æœ¬</span><br><span class="line">    shuffle=True,              # æ¯ä¸ª epoch å¼€å§‹å‰æ‰“ä¹±æ•°æ®é¡ºåºï¼Œæé«˜æ³›åŒ–èƒ½åŠ›</span><br><span class="line">    num_workers=2              # ä½¿ç”¨2ä¸ªå­è¿›ç¨‹åŠ è½½æ•°æ®ï¼ŒåŠ å¿«æ•°æ®è¯»å–é€Ÿåº¦</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># åˆ›å»ºæµ‹è¯•é›†å¯¹è±¡</span><br><span class="line">testset = torchvision.datasets.CIFAR10(</span><br><span class="line">    root=&#x27;/path/to/data&#x27;,      # æ•°æ®å­˜å‚¨è·¯å¾„</span><br><span class="line">    train=False,               # è¡¨ç¤ºè¿™æ˜¯æµ‹è¯•é›†</span><br><span class="line">    download=True,             # å¦‚æœæœ¬åœ°æ²¡æœ‰æ•°æ®ï¼Œåˆ™è‡ªåŠ¨ä¸‹è½½</span><br><span class="line">    transform=transform        # åŒæ ·åº”ç”¨é¢„å¤„ç†æ“ä½œ</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># åˆ›å»ºæµ‹è¯•é›†çš„æ•°æ®åŠ è½½å™¨ DataLoader</span><br><span class="line">testloader = torch.utils.data.DataLoader(</span><br><span class="line">    testset,                   # ä½¿ç”¨çš„æ•°æ®é›†</span><br><span class="line">    batch_size=4,              # æ¯ä¸ªæ‰¹æ¬¡åŒ…å«4ä¸ªæ ·æœ¬</span><br><span class="line">    shuffle=False,             # æµ‹è¯•æ—¶ä¸æ‰“ä¹±æ•°æ®ï¼Œæ–¹ä¾¿è¯„ä¼°æ¨¡å‹</span><br><span class="line">    num_workers=2              # åŒæ ·ä½¿ç”¨2ä¸ªå­è¿›ç¨‹åŠ é€Ÿæ•°æ®åŠ è½½</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># CIFAR-10 æ•°æ®é›†ä¸­10ä¸ªç±»åˆ«çš„æ ‡ç­¾åç§°ï¼ˆç”¨äºåç»­å¯è§†åŒ–æˆ–æ‰“å°é¢„æµ‹ç»“æœï¼‰</span><br><span class="line">classes = (&#x27;plane&#x27;, &#x27;car&#x27;, &#x27;bird&#x27;, &#x27;cat&#x27;,</span><br><span class="line">           &#x27;deer&#x27;, &#x27;dog&#x27;, &#x27;frog&#x27;, &#x27;horse&#x27;, &#x27;ship&#x27;, &#x27;truck&#x27;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-4-ä¸€ä¸ªå®Œæ•´çš„è®­ç»ƒ-æ¨ç†æµç¨‹"><a href="#3-4-ä¸€ä¸ªå®Œæ•´çš„è®­ç»ƒ-æ¨ç†æµç¨‹" class="headerlink" title="3.4 ä¸€ä¸ªå®Œæ•´çš„è®­ç»ƒ+æ¨ç†æµç¨‹"></a>3.4 ä¸€ä¸ªå®Œæ•´çš„è®­ç»ƒ+æ¨ç†æµç¨‹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">import torch.nn as nn</span><br><span class="line">import torch.nn.functional as F</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Net(nn.Module):</span><br><span class="line">  def __init__(self):</span><br><span class="line">    super(Net, self).__init__()</span><br><span class="line">    self.conv1 = nn.Conv2d(3, 6, 5)</span><br><span class="line">    self.pool = nn.MaxPool2d(2, 2)</span><br><span class="line">    self.conv2 = nn.Conv2d(6, 16, 5)</span><br><span class="line">    self.fc1 = nn.Linear(16 * 5 * 5, 120)</span><br><span class="line">    self.fc2 = nn.Linear(120, 84)</span><br><span class="line">    self.fc3 = nn.Linear(84, 10)</span><br><span class="line"></span><br><span class="line">  def forward(self, x):</span><br><span class="line">    x = self.pool(F.relu(self.conv1(x)))</span><br><span class="line">    x = self.pool(F.relu(self.conv2(x)))</span><br><span class="line">    x = x.view(-1, 16 * 5 * 5)</span><br><span class="line">    x = F.relu(self.fc1(x))</span><br><span class="line">    x = F.relu(self.fc2(x))</span><br><span class="line">    x = self.fc3(x)</span><br><span class="line">    return x</span><br><span class="line"></span><br><span class="line">net = Net()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨äº¤å‰ç†µæŸå¤±å‡½æ•°ï¼ŒOptimizerä½¿ç”¨å¸¦å†²é‡çš„SGDã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import torch.optim as optim</span><br><span class="line"></span><br><span class="line">criterion = nn.CrossEntropyLoss()</span><br><span class="line">optimizer = optim.SGD(net.parameters(), lr=0.001, momentum=0.9)</span><br></pre></td></tr></table></figure>

<p>éå†DataLoaderè¿›è¡Œè®­ç»ƒã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">for epoch in range(2):  # è¿™é‡Œåªè¿­ä»£2ä¸ªepochï¼Œå®é™…åº”è¯¥è¿›è¡Œæ›´å¤šæ¬¡è®­ç»ƒ</span><br><span class="line"></span><br><span class="line">  running_loss = 0.0</span><br><span class="line">  for i, data in enumerate(trainloader, 0):</span><br><span class="line">    # å¾—åˆ°è¾“å…¥</span><br><span class="line">    inputs, labels = data</span><br><span class="line"></span><br><span class="line">    # æ¢¯åº¦æ¸…é›¶</span><br><span class="line">    optimizer.zero_grad()</span><br><span class="line"></span><br><span class="line">    # forward + backward + optimize</span><br><span class="line">    outputs = net(inputs)</span><br><span class="line">    loss = criterion(outputs, labels)</span><br><span class="line">    loss.backward()</span><br><span class="line">    optimizer.step()</span><br><span class="line"></span><br><span class="line">    # å®šä¹‰ç»Ÿè®¡ä¿¡æ¯</span><br><span class="line">    running_loss += loss.item()</span><br><span class="line">    if i % 2000 == 1999:</span><br><span class="line">      print(&#x27;[%d, %5d] loss: %.3f&#x27; %</span><br><span class="line">        (epoch + 1, i + 1, running_loss / 2000))</span><br><span class="line">    running_loss = 0.0</span><br><span class="line"></span><br><span class="line">print(&#x27;Finished Training&#x27;)</span><br></pre></td></tr></table></figure>

<p>åœ¨æµ‹è¯•é›†ä¸Šè¿›è¡Œæµ‹è¯•ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">correct = 0</span><br><span class="line">total = 0</span><br><span class="line">with torch.no_grad():</span><br><span class="line">for data in testloader:</span><br><span class="line">  images, labels = data</span><br><span class="line">  outputs = net(images)</span><br><span class="line">  _, predicted = torch.max(outputs.data, 1)</span><br><span class="line">  total += labels.size(0)</span><br><span class="line">  correct += (predicted == labels).sum().item()</span><br><span class="line"></span><br><span class="line">print(&#x27;Accuracy of the network on the 10000 test images: %d %%&#x27; % (</span><br><span class="line">  100 * correct / total))</span><br></pre></td></tr></table></figure>

<h3 id="3-5-åœ¨GPUä¸Šè®­ç»ƒ"><a href="#3-5-åœ¨GPUä¸Šè®­ç»ƒ" class="headerlink" title="3.5 åœ¨GPUä¸Šè®­ç»ƒ"></a>3.5 åœ¨GPUä¸Šè®­ç»ƒ</h3><p>ä½¿ç”¨ <code>torch.device</code> å°†Tensorç§»åˆ°GPUä¸Š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">device = torch.device(&quot;cuda:0&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span><br><span class="line">print(device)</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨GPUè¿›è¡Œè®­ç»ƒ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">class Net2(nn.Module):</span><br><span class="line">def __init__(self):</span><br><span class="line">super(Net2, self).__init__()</span><br><span class="line">self.conv1 = nn.Conv2d(3, 6, 5).to(device)</span><br><span class="line">self.pool = nn.MaxPool2d(2, 2).to(device)</span><br><span class="line">self.conv2 = nn.Conv2d(6, 16, 5).to(device)</span><br><span class="line">self.fc1 = nn.Linear(16 * 5 * 5, 120).to(device)</span><br><span class="line">self.fc2 = nn.Linear(120, 84).to(device)</span><br><span class="line">self.fc3 = nn.Linear(84, 10).to(device)</span><br><span class="line"></span><br><span class="line">def forward(self, x):</span><br><span class="line">x = self.pool(F.relu(self.conv1(x)))</span><br><span class="line">x = self.pool(F.relu(self.conv2(x)))</span><br><span class="line">x = x.view(-1, 16 * 5 * 5)</span><br><span class="line">x = F.relu(self.fc1(x))</span><br><span class="line">x = F.relu(self.fc2(x))</span><br><span class="line">x = self.fc3(x)</span><br><span class="line">return x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">net = Net2()</span><br><span class="line">criterion = nn.CrossEntropyLoss()</span><br><span class="line">optimizer = optim.SGD(net.parameters(), lr=0.001, momentum=0.9)</span><br><span class="line"></span><br><span class="line">for epoch in range(20):</span><br><span class="line"></span><br><span class="line">  running_loss = 0.0</span><br><span class="line">  for i, data in enumerate(trainloader, 0):</span><br><span class="line">    # å¾—åˆ°è¾“å…¥</span><br><span class="line">    inputs, labels = data</span><br><span class="line">    inputs, labels = inputs.to(device), labels.to(device)</span><br><span class="line">    # æ¢¯åº¦æ¸…é›¶</span><br><span class="line">    optimizer.zero_grad()</span><br><span class="line"></span><br><span class="line">    # forward + backward + optimize</span><br><span class="line">    outputs = net(inputs)</span><br><span class="line">    loss = criterion(outputs, labels)</span><br><span class="line">    loss.backward()</span><br><span class="line">    optimizer.step()</span><br><span class="line"></span><br><span class="line">    # å®šä¹‰ç»Ÿè®¡ä¿¡æ¯</span><br><span class="line">    running_loss += loss.item()</span><br><span class="line">    if i % 2000 == 1999:</span><br><span class="line">      print(&#x27;[%d, %5d] loss: %.3f&#x27; %</span><br><span class="line">        (epoch + 1, i + 1, running_loss / 2000))</span><br><span class="line">      running_loss = 0.0</span><br><span class="line"></span><br><span class="line">    print(&#x27;Finished Training&#x27;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-6-ä½¿ç”¨autogradæ¥å®ç°ä¸‰å±‚ç¥ç»ç½‘ç»œ"><a href="#3-6-ä½¿ç”¨autogradæ¥å®ç°ä¸‰å±‚ç¥ç»ç½‘ç»œ" class="headerlink" title="3.6 ä½¿ç”¨autogradæ¥å®ç°ä¸‰å±‚ç¥ç»ç½‘ç»œ"></a>3.6 ä½¿ç”¨autogradæ¥å®ç°ä¸‰å±‚ç¥ç»ç½‘ç»œ</h3><p>å®ç°ä¸€ä¸ªå…¨è¿æ¥ç½‘ç»œï¼Œåªæœ‰ä¸€ä¸ªéšå±‚è€Œä¸”æ²¡æœ‰biasï¼Œä½¿ç”¨æ¬§æ°è·ç¦»ä½œä¸ºæŸå¤±å‡½æ•°ã€‚ä½¿ç”¨PyTorchçš„Tensoræ¥è®¡ç®—å‰å‘é˜¶æ®µï¼Œç„¶åä½¿ç”¨PyTorchçš„autogradæ¥è‡ªåŠ¨å¸®æˆ‘ä»¬åå‘è®¡ç®—æ¢¯åº¦ã€‚PyTorchçš„Tensorä»£è¡¨äº†è®¡ç®—å›¾ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ã€‚å¦‚æœxæ˜¯ä¸€ä¸ªTensorå¹¶ä¸”x.requires_grad&#x3D;Trueï¼Œé‚£ä¹ˆx.gradè¿™ä¸ªTensorä¼šä¿å­˜æŸä¸ªscalar(é€šå¸¸æ˜¯loss)å¯¹xçš„æ¢¯åº¦ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">import torch</span><br><span class="line"></span><br><span class="line">dtype = torch.float</span><br><span class="line">device = torch.device(&quot;cpu&quot;)</span><br><span class="line"></span><br><span class="line"># Næ˜¯batch sizeï¼›D_inæ˜¯è¾“å…¥å¤§å°</span><br><span class="line"># Hæ˜¯éšå±‚çš„å¤§å°ï¼›D_outæ˜¯è¾“å‡ºå¤§å°</span><br><span class="line">N, D_in, H, D_out = 64, 1000, 100, 10</span><br><span class="line"></span><br><span class="line"># åˆ›å»ºéšæœºçš„Tensorä½œä¸ºè¾“å…¥å’Œè¾“å‡º</span><br><span class="line"># è¾“å…¥å’Œè¾“å‡ºéœ€è¦çš„requires_grad=False(é»˜è®¤)</span><br><span class="line">x = torch.randn(N, D_in, device=device, dtype=dtype)</span><br><span class="line">y = torch.randn(N, D_out, device=device, dtype=dtype)</span><br><span class="line"></span><br><span class="line"># åˆ›å»ºweightçš„Tensorï¼Œéœ€è¦è®¾ç½®requires_grad=True</span><br><span class="line">w1 = torch.randn(D_in, H, device=device, dtype=dtype, requires_grad=True)</span><br><span class="line">w2 = torch.randn(H, D_out, device=device, dtype=dtype, requires_grad=True)</span><br><span class="line"></span><br><span class="line">learning_rate = 1e-6</span><br><span class="line">for t in range(500):</span><br><span class="line">  # Forwardé˜¶æ®µ: mmå®ç°çŸ©é˜µä¹˜æ³•ï¼Œä½†æ˜¯å®ƒä¸æ”¯æŒbroadcastingã€‚</span><br><span class="line">  # å¦‚æœéœ€è¦broadcastingï¼Œå¯ä»¥ä½¿ç”¨matmul</span><br><span class="line">  # clampæœ¬æ¥çš„ç”¨é€”æ˜¯æŠŠå€¼clampåˆ°æŒ‡å®šçš„èŒƒå›´ï¼Œè¿™é‡Œå®ç°ReLUã€‚</span><br><span class="line">  y_pred = x.mm(w1).clamp(min=0).mm(w2)</span><br><span class="line"></span><br><span class="line">  # pow(2)å®ç°å¹³æ–¹è®¡ç®—ã€‚</span><br><span class="line">  # loss.item()å¾—åˆ°è¿™ä¸ªtensorçš„å€¼ã€‚ä¹Ÿå¯ä»¥ç›´æ¥æ‰“å°lossï¼Œè¿™ä¼šæ‰“å°å¾ˆå¤šé™„åŠ ä¿¡æ¯ã€‚</span><br><span class="line">  loss = (y_pred - y).pow(2).sum()</span><br><span class="line">  print(t, loss.item())</span><br><span class="line"></span><br><span class="line">  # ä½¿ç”¨autogradè¿›è¡Œåå‘è®¡ç®—ã€‚å®ƒä¼šè®¡ç®—losså¯¹æ‰€æœ‰å¯¹å®ƒæœ‰å½±å“çš„</span><br><span class="line">  # requires_grad=Trueçš„Tensorçš„æ¢¯åº¦ã€‚</span><br><span class="line"></span><br><span class="line">  loss.backward()</span><br><span class="line"></span><br><span class="line">  # æ‰‹åŠ¨ä½¿ç”¨æ¢¯åº¦ä¸‹é™æ›´æ–°å‚æ•°ã€‚ä¸€å®šè¦æŠŠæ›´æ–°çš„ä»£ç æ”¾åˆ°torch.no_grad()é‡Œ</span><br><span class="line">  # å¦åˆ™ä¸‹é¢çš„æ›´æ–°ä¹Ÿä¼šè®¡ç®—æ¢¯åº¦ã€‚åé¢æˆ‘ä»¬ä¼šä½¿ç”¨torch.optim.SGDï¼Œ</span><br><span class="line">  # å®ƒä¼šå¸®æˆ‘ä»¬ç®¡ç†è¿™äº›ç”¨äºæ›´æ–°æ¢¯åº¦çš„è®¡ç®—ã€‚</span><br><span class="line"></span><br><span class="line">  with torch.no_grad():</span><br><span class="line">    w1 -= learning_rate * w1.grad</span><br><span class="line">    w2 -= learning_rate * w2.grad</span><br><span class="line"></span><br><span class="line">    # æ‰‹åŠ¨æŠŠæ¢¯åº¦æ¸…é›¶</span><br><span class="line">    w1.grad.zero_()</span><br><span class="line">    w2.grad.zero_()</span><br></pre></td></tr></table></figure>

<h2 id="4-è¿ç§»å­¦ä¹ "><a href="#4-è¿ç§»å­¦ä¹ " class="headerlink" title="4. è¿ç§»å­¦ä¹ "></a><strong>4. è¿ç§»å­¦ä¹ </strong></h2><p>ä¸€èˆ¬æ¥è¯´æˆ‘ä»¬çš„è®­ç»ƒæ•°æ®é‡ä¸ä¼šå¾ˆå¤§ï¼Œå¾ˆéš¾è¾¾åˆ°åƒImageNeté‚£æ ·ä¸Šç™¾ä¸‡çš„æ ‡æ³¨æ•°æ®é›†ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿ç§»å­¦ä¹ æ¥è§£å†³è®­ç»ƒæ•°æ®ä¸è¶³çš„é—®é¢˜ã€‚è¿ç§»å­¦ä¹ é‡Œï¼Œæˆ‘ä»¬æ ¹æ®è®­ç»ƒæ•°æ®çš„å¤šå°‘é€šå¸¸å¯ä»¥é‡‡å–å¦‚ä¸‹æ–¹æ³•ï¼š</p>
<ul>
<li><p>è®­ç»ƒæ•°æ®å¾ˆå°‘</p>
<p>  é‚£ä¹ˆæˆ‘ä»¬é€šå¸¸æŠŠä¸€ä¸ªpretraningçš„ç½‘ç»œçš„å¤§éƒ¨åˆ†å›ºå®šä½ï¼Œç„¶ååªæ˜¯æŠŠæœ€åä¸€ä¸ªå…¨è¿æ¥å±‚æ¢æˆæ–°çš„(æœ€åä¸€å±‚é€šå¸¸æ˜¯ä¸ä¸€æ ·çš„ï¼Œå› ä¸ºåˆ†ç±»çš„æ•°é‡ä¸åŒ)ï¼Œç„¶ååªè®­ç»ƒè¿™ä¸€å±‚</p>
</li>
<li><p>è®­ç»ƒæ•°æ®è¾ƒå¤š</p>
<p>  æˆ‘ä»¬å¯ä»¥æŠŠpretrainingçš„ç½‘ç»œçš„å‰é¢ä¸€äº›å±‚å›ºå®šä½ï¼Œä½†åé¢çš„å±‚ä¸å›ºå®šï¼ŒæŠŠæœ€åä¸€å±‚æ¢æ–°çš„ï¼Œç„¶åè®­ç»ƒ</p>
</li>
<li><p>è®­ç»ƒæ•°æ®å¾ˆå¤š</p>
<p>  æ‰€æœ‰çš„pretrainingçš„å±‚éƒ½å¯ä»¥fine-tuningï¼Œåªæ˜¯ç”¨pretrainingçš„å‚æ•°ä½œä¸ºåˆå§‹åŒ–å‚æ•°ã€‚</p>
</li>
</ul>
<h3 id="4-1-å¼•å…¥ä¾èµ–"><a href="#4-1-å¼•å…¥ä¾èµ–" class="headerlink" title="4.1 å¼•å…¥ä¾èµ–"></a>4.1 å¼•å…¥ä¾èµ–</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">from __future__ import print_function, division</span><br><span class="line"></span><br><span class="line">import torch</span><br><span class="line">import torch.nn as nn</span><br><span class="line">import torch.optim as optim</span><br><span class="line">from torch.optim import lr_scheduler</span><br><span class="line">import numpy as np</span><br><span class="line">import torchvision</span><br><span class="line">from torchvision import datasets, models, transforms</span><br><span class="line">import matplotlib.pyplot as plt</span><br><span class="line">import time</span><br><span class="line">import os</span><br><span class="line">import copy</span><br><span class="line"></span><br><span class="line">plt.ion()</span><br></pre></td></tr></table></figure>

<h3 id="4-2-åŠ è½½æ•°æ®"><a href="#4-2-åŠ è½½æ•°æ®" class="headerlink" title="4.2 åŠ è½½æ•°æ®"></a>4.2 åŠ è½½æ•°æ®</h3><p>ä½¿ç”¨torchvisionå’Œtorch.utils.dataåŒ…æ¥åŠ è½½æ•°æ®ã€‚æˆ‘ä»¬è¦è§£å†³çš„é—®é¢˜æ˜¯è®­ç»ƒä¸€ä¸ªæ¨¡å‹æ¥åŒºåˆ†èš‚èšå’Œèœœèœ‚ï¼Œæ¯ä¸ªç±»åˆ«æˆ‘ä»¬å¤§æ¦‚æœ‰120ä¸ªè®­ç»ƒæ•°æ®ï¼Œå¦å¤–æ¯ä¸ªç±»æœ‰75ä¸ªéªŒè¯æ•°æ®ã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆå°çš„è®­ç»ƒé›†ï¼Œå¦‚æœç›´æ¥ç”¨ä¸€ä¸ªç¥ç»ç½‘ç»œæ¥è®­ç»ƒï¼Œæ•ˆæœä¼šå¾ˆå·®ã€‚ç°åœ¨æˆ‘ä»¬ç”¨è¿ç§»å­¦ä¹ æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æ•°æ®å¯ä»¥åœ¨<a target="_blank" rel="noopener" href="https://download.pytorch.org/tutorial/hymenoptera_data.zip">è¿™é‡Œ</a>ä¸‹è½½ï¼Œä¸‹è½½åè¯·è§£å‹åˆ°dataç›®å½•ä¸‹ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># è®­ç»ƒæ—¶ä¼šåšæ•°æ®å¢å¼ºå’Œå½’ä¸€åŒ–</span><br><span class="line"># éªŒè¯çš„æ—¶å€™åªåšå½’ä¸€åŒ–</span><br><span class="line">data_transforms = &#123;</span><br><span class="line">  &#x27;train&#x27;: transforms.Compose([</span><br><span class="line">    transforms.RandomResizedCrop(224),</span><br><span class="line">    transforms.RandomHorizontalFlip(),</span><br><span class="line">    transforms.ToTensor(),</span><br><span class="line">    transforms.Normalize([0.485, 0.456, 0.406], [0.229, 0.224, 0.225])</span><br><span class="line">  ]),</span><br><span class="line">  &#x27;val&#x27;: transforms.Compose([</span><br><span class="line">    transforms.Resize(256),</span><br><span class="line">    transforms.CenterCrop(224),</span><br><span class="line">    transforms.ToTensor(),</span><br><span class="line">    transforms.Normalize([0.485, 0.456, 0.406], [0.229, 0.224, 0.225])</span><br><span class="line">  ]),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data_dir = &#x27;../data/hymenoptera_data&#x27;</span><br><span class="line">image_datasets = &#123;x: datasets.ImageFolder(os.path.join(data_dir, x),</span><br><span class="line">    data_transforms[x])</span><br><span class="line">  for x in [&#x27;train&#x27;, &#x27;val&#x27;]&#125;</span><br><span class="line">dataloaders = &#123;x: torch.utils.data.DataLoader(image_datasets[x], batch_size=4,</span><br><span class="line">    shuffle=True, num_workers=4)</span><br><span class="line">  for x in [&#x27;train&#x27;, &#x27;val&#x27;]&#125;</span><br><span class="line">dataset_sizes = &#123;x: len(image_datasets[x]) for x in [&#x27;train&#x27;, &#x27;val&#x27;]&#125;</span><br><span class="line">class_names = image_datasets[&#x27;train&#x27;].classes</span><br><span class="line"></span><br><span class="line">device = torch.device(&quot;cuda:0&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span><br></pre></td></tr></table></figure>

<h3 id="4-3-è®­ç»ƒæ¨¡å‹"><a href="#4-3-è®­ç»ƒæ¨¡å‹" class="headerlink" title="4.3 è®­ç»ƒæ¨¡å‹"></a>4.3 è®­ç»ƒæ¨¡å‹</h3><p>åœ¨æ­¤å®ç°ä¸€ä¸ªç”¨äºè®­ç»ƒæ¨¡å‹çš„é€šç”¨å‡½æ•°ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li>learning rateçš„è‡ªé€‚åº”</li>
<li>ä¿å­˜æœ€å¥½çš„æ¨¡å‹</li>
</ul>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">def <span class="title function_">train_model</span>(model, criterion, optimizer, shceduler, num_epochs=<span class="number">25</span>):</span><br><span class="line">				since = time.<span class="title function_">time</span>()</span><br><span class="line">				</span><br><span class="line">				best_model_wts = copy.<span class="title function_">deepcopy</span>(model.<span class="title function_">state_dict</span>())</span><br><span class="line">				best_acc = <span class="number">0.0</span></span><br><span class="line">				</span><br><span class="line">				<span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="title function_">range</span>(num_epochs):</span><br><span class="line">								<span class="title function_">print</span>(<span class="string">&#x27;Epoch &#123;&#125;/&#123;&#125;&#x27;</span>.<span class="title function_">format</span>(epoch, num_epochs - <span class="number">1</span>))</span><br><span class="line">								<span class="title function_">print</span>(<span class="string">&#x27;-&#x27;</span> * <span class="number">10</span>)</span><br><span class="line">								</span><br><span class="line">								# æ¯ä¸ªepochéƒ½åˆ†ä¸ºè®­ç»ƒå’ŒéªŒè¯é˜¶æ®µ</span><br><span class="line">								<span class="keyword">for</span> phase <span class="keyword">in</span> [<span class="string">&#x27;train&#x27;</span>, <span class="string">&#x27;val&#x27;</span>]:</span><br><span class="line">												<span class="keyword">if</span> phase == <span class="string">&#x27;train&#x27;</span>:</span><br><span class="line">																scheduler.<span class="title function_">step</span>()</span><br><span class="line">																model.<span class="title function_">train</span>()   # è®­ç»ƒé˜¶æ®µ</span><br><span class="line">												<span class="attr">else</span>:</span><br><span class="line">																model.<span class="built_in">eval</span>()    #éªŒè¯é˜¶æ®µ</span><br><span class="line">																</span><br><span class="line">												running_loss = <span class="number">0.0</span></span><br><span class="line">												running_corrects = <span class="number">0</span></span><br><span class="line">												</span><br><span class="line">												# å˜é‡æ•°æ®é›†</span><br><span class="line">												<span class="keyword">for</span> inputs, labels <span class="keyword">in</span> dataloaders[phase]:</span><br><span class="line">																inputs = inputs.<span class="title function_">to</span>(device)</span><br><span class="line">																labels = labels.<span class="title function_">to</span>(device)</span><br><span class="line">																</span><br><span class="line">												# æ¸…ç©ºå‚æ•°æ¢¯åº¦</span><br><span class="line">												optimizer.<span class="title function_">zero_grad</span>()</span><br><span class="line">												</span><br><span class="line">												# forward</span><br><span class="line">												# åªæœ‰è®­ç»ƒçš„æ—¶å€™trackç”¨äºæ¢¯åº¦è®¡ç®—çš„å†å²ä¿¡æ¯</span><br><span class="line">												<span class="keyword">with</span> torch.<span class="title function_">set_grad_enable</span>(phase == <span class="string">&#x27;train&#x27;</span>):</span><br><span class="line">																outputs = <span class="title function_">model</span>(inputs)</span><br><span class="line">																_, preds = torch.<span class="title function_">max</span>(outputs, <span class="number">1</span>)</span><br><span class="line">																loss = <span class="title function_">criterion</span>(outputs, labels)</span><br><span class="line">																</span><br><span class="line">																# å¦‚æœæ˜¯è®­ç»ƒï¼Œéœ€è¦backwardå’Œæ›´æ–°å‚æ•°</span><br><span class="line">																<span class="keyword">if</span> phase == <span class="string">&#x27;train&#x27;</span>:</span><br><span class="line">																				loss.<span class="title function_">backward</span>()</span><br><span class="line">																				optimizer.<span class="title function_">step</span>()</span><br><span class="line">																				</span><br><span class="line">												runnning_loss += loss.<span class="title function_">item</span>() * inputs.<span class="title function_">size</span>(<span class="number">0</span>)</span><br><span class="line">												running_corrects += torch.<span class="title function_">sum</span>(preds == labels.<span class="property">data</span>)</span><br><span class="line">												</span><br><span class="line">												epoch_loss = running_loss / dataset_sizes[phase]</span><br><span class="line">												epoch_corrects = running_corrects.<span class="title function_">double</span>() / dataset_sizes[phase]</span><br><span class="line">												</span><br><span class="line">												<span class="title function_">print</span>(<span class="string">&#x27;&#123;&#125; Loss: &#123;:.4f&#125; Acc: &#123;:.4f&#125;&#x27;</span>.<span class="title function_">format</span>(</span><br><span class="line">																phase, epoch_loss, epoch_acc))</span><br><span class="line">																</span><br><span class="line">												# ä¿å­˜éªŒè¯é›†ä¸Šçš„æœ€ä½³æ¨¡å‹</span><br><span class="line">												<span class="keyword">if</span> phase == <span class="string">&#x27;val&#x27;</span> and epoch_acc &gt; <span class="attr">best_acc</span>:</span><br><span class="line">																best_acc = epoch_acc</span><br><span class="line">																best_model_wts = copy.<span class="title function_">deepcopy</span>(model.<span class="title function_">state_dict</span>())</span><br><span class="line">												<span class="title function_">print</span>()</span><br><span class="line">								</span><br><span class="line">				time_elapsed = time.<span class="title function_">time</span>() - since</span><br><span class="line">				<span class="title function_">print</span>(<span class="string">&#x27;Training complete in &#123;:.0f&#125;m &#123;:.0f&#125;s&#x27;</span>.<span class="title function_">format</span>(</span><br><span class="line">time_elapsed <span class="comment">// 60, time_elapsed % 60))</span></span><br><span class="line">				<span class="title function_">print</span>(<span class="string">&#x27;Best val Acc: &#123;:4f&#125;&#x27;</span>.<span class="title function_">format</span>(best_acc))</span><br><span class="line">				</span><br><span class="line">				# åŠ è½½æœ€ä¼˜æ¨¡å‹</span><br><span class="line">				model.<span class="title function_">load_state_dict</span>(best_model_wts)</span><br><span class="line">				<span class="keyword">return</span> model</span><br></pre></td></tr></table></figure>

<h3 id="4-4-å¯è§†åŒ–é¢„æµ‹ç»“æœçš„å‡½æ•°"><a href="#4-4-å¯è§†åŒ–é¢„æµ‹ç»“æœçš„å‡½æ•°" class="headerlink" title="4.4 å¯è§†åŒ–é¢„æµ‹ç»“æœçš„å‡½æ•°"></a>4.4 å¯è§†åŒ–é¢„æµ‹ç»“æœçš„å‡½æ•°</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">def <span class="title function_">visualize_model</span>(model, num_images=<span class="number">6</span>):</span><br><span class="line">				was_training = model.<span class="property">training</span></span><br><span class="line">				model.<span class="built_in">eval</span>()</span><br><span class="line">				images_so_far = <span class="number">0</span></span><br><span class="line">				fig = plt.<span class="title function_">figure</span>()</span><br><span class="line">				</span><br><span class="line">				<span class="keyword">with</span> torch.<span class="title function_">no_grad</span>():</span><br><span class="line">								<span class="keyword">for</span> i, (inputs, labels) <span class="keyword">in</span> <span class="title function_">enumerate</span>(dataloaders[<span class="string">&#x27;val&#x27;</span>]):</span><br><span class="line">												inputs = inputs.<span class="title function_">to</span>(device)</span><br><span class="line">												labels = labels.<span class="title function_">to</span>(device)</span><br><span class="line">												</span><br><span class="line">												outputs = <span class="title function_">model</span>(inputs)</span><br><span class="line">												_, preds = torch.<span class="title function_">max</span>(outputs, <span class="number">1</span>)</span><br><span class="line">												</span><br><span class="line">												<span class="keyword">for</span> j <span class="keyword">in</span> <span class="title function_">range</span>(inputs.<span class="title function_">size</span>()[<span class="number">0</span>]):</span><br><span class="line">																images_so_far += <span class="number">1</span></span><br><span class="line">																ax = plt.<span class="title function_">subplot</span>(num_images<span class="comment">//2, 2, images_so_far)</span></span><br><span class="line">																ax.<span class="title function_">axis</span>(<span class="string">&#x27;off&#x27;</span>)</span><br><span class="line">																ax.<span class="title function_">set_title</span>(<span class="string">&#x27;predicted: &#123;&#125;&#x27;</span>.<span class="title function_">format</span>(class_names[preds[j]]))</span><br><span class="line">																<span class="title function_">imshow</span>(inputs.<span class="title function_">cpu</span>().<span class="property">data</span>[j])</span><br><span class="line">																</span><br><span class="line">																<span class="keyword">if</span> images_so_far == <span class="attr">num_images</span>:</span><br><span class="line">																				model.<span class="title function_">train</span>(mode=was_training)</span><br><span class="line">																				<span class="keyword">return</span></span><br><span class="line">								model.<span class="title function_">train</span>(mode=was_training)</span><br></pre></td></tr></table></figure>

<h3 id="4-5-fine-tuning-æ‰€æœ‰å‚æ•°"><a href="#4-5-fine-tuning-æ‰€æœ‰å‚æ•°" class="headerlink" title="4.5 fine-tuning æ‰€æœ‰å‚æ•°"></a>4.5 fine-tuning æ‰€æœ‰å‚æ•°</h3><p>é¦–å…ˆåŠ è½½ä¸€ä¸ªé¢„è®­ç»ƒçš„æ¨¡å‹(imagenetä¸Šçš„resnet)ï¼Œå› ä¸ºæˆ‘ä»¬çš„ç±»åˆ«æ•°å’Œimagenetä¸åŒï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åˆ æ‰åŸæ¥çš„å…¨è¿æ¥å±‚ï¼Œæ¢æˆæ–°çš„å…¨è¿æ¥å±‚ã€‚è¿™é‡Œæˆ‘ä»¬è®©æ‰€æœ‰çš„æ¨¡å‹å‚æ•°éƒ½å¯ä»¥è°ƒæ•´ï¼ŒåŒ…æ‹¬æ–°åŠ çš„å…¨è¿æ¥å±‚å’Œé¢„è®­ç»ƒçš„å±‚ã€‚</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">model_ft = models.<span class="title function_">resent18</span>(pretrained=<span class="title class_">True</span>) # åŠ è½½é¢„è®­ç»ƒæ¨¡å‹</span><br><span class="line">num_ftrs = model_ft.<span class="property">fc</span>.<span class="property">in_features</span> # è·å–æœ€åä¸€å±‚è¾“å…¥ç‰¹å¾å€¼</span><br><span class="line">model_ft.<span class="property">fc</span> = nn.<span class="title class_">Linear</span>(num_ftrs, <span class="number">2</span>) # æ›¿æ¢æœ€åä¸€å±‚å…¨è¿æ¥å±‚</span><br><span class="line"></span><br><span class="line">model_ft = model_ft.<span class="title function_">to</span>(device)</span><br><span class="line"></span><br><span class="line"># æ‰€æœ‰å‚æ•°éƒ½å¯ä»¥è®­ç»ƒ</span><br><span class="line">optimizer_ft = optim.<span class="title function_">SGD</span>(model_ft.<span class="title function_">parameters</span>(), lr=<span class="number">0.001</span>, momentum=<span class="number">0.9</span>)</span><br><span class="line"></span><br><span class="line"># æ¯<span class="number">7</span>ä¸ªepoch learning rateå˜ä¸ºåŸæ¥çš„<span class="number">10</span>% </span><br><span class="line">exp_lr_scheduler = lr_scheduler.<span class="title class_">StepLR</span>(optimizer_ft, step_size=<span class="number">7</span>, gamma=<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line">model_ft = <span class="title function_">train_model</span>(model_ft, criterion, optimizer_ft, exp_lr_scheduler,</span><br><span class="line">	num_epochs=<span class="number">25</span>)</span><br></pre></td></tr></table></figure>

<h3 id="4-6-fine-tuning-æœ€åä¸€å±‚å‚æ•°"><a href="#4-6-fine-tuning-æœ€åä¸€å±‚å‚æ•°" class="headerlink" title="4.6 fine-tuning æœ€åä¸€å±‚å‚æ•°"></a>4.6 fine-tuning æœ€åä¸€å±‚å‚æ•°</h3><p>æˆ‘ä»¬ç”¨å¯ä»¥å›ºå®šä½å‰é¢å±‚çš„å‚æ•°ï¼Œåªè®­ç»ƒæœ€åä¸€å±‚ã€‚è¿™æ¯”ä¹‹å‰è¦å¿«å°†è¿‘ä¸€å€ï¼Œå› ä¸ºåå‘è®¡ç®—æ¢¯åº¦åªéœ€è¦è®¡ç®—æœ€åä¸€å±‚ã€‚ä½†æ˜¯å‰å‘è®¡ç®—çš„æ—¶é—´æ˜¯ä¸€æ ·çš„ã€‚</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">model_conv = torchvision.<span class="property">models</span>.<span class="title function_">resnet18</span>(pretrained=<span class="title class_">True</span>)</span><br><span class="line"></span><br><span class="line"># å†»ç»“æ‰€æœ‰å‚æ•°</span><br><span class="line"><span class="keyword">for</span> param <span class="keyword">in</span> model_conv.<span class="title function_">parameters</span>():</span><br><span class="line">	param.<span class="property">requires_grad</span> = <span class="title class_">False</span></span><br><span class="line"></span><br><span class="line"># æ–°åŠ çš„å±‚é»˜è®¤requires_grad=<span class="title class_">True</span> </span><br><span class="line">num_ftrs = model_conv.<span class="property">fc</span>.<span class="property">in_features</span></span><br><span class="line">model_conv.<span class="property">fc</span> = nn.<span class="title class_">Linear</span>(num_ftrs, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">model_conv = model_conv.<span class="title function_">to</span>(device)</span><br><span class="line"></span><br><span class="line">criterion = nn.<span class="title class_">CrossEntropyLoss</span>()</span><br><span class="line"></span><br><span class="line"># å€¼è®­ç»ƒæœ€åä¸€ä¸ªå…¨è¿æ¥å±‚ã€‚</span><br><span class="line">optimizer_conv = optim.<span class="title function_">SGD</span>(model_conv.<span class="property">fc</span>.<span class="title function_">parameters</span>(), lr=<span class="number">0.001</span>, momentum=<span class="number">0.9</span>)</span><br><span class="line"></span><br><span class="line">exp_lr_scheduler = lr_scheduler.<span class="title class_">StepLR</span>(optimizer_conv, step_size=<span class="number">7</span>, gamma=<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line">model_conv = <span class="title function_">train_model</span>(model_conv, criterion, optimizer_conv,</span><br><span class="line">	exp_lr_scheduler, num_epochs=<span class="number">25</span>)</span><br></pre></td></tr></table></figure>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Latteo, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
    </div>
    

    <div class="container post-prev-next">
        <a class="next"></a>
        
        <a href="/2025/06/24/start-my-blog/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">start_my_blog</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
        </div>
        <span>&copy; 2025 Latteo<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>